/*
 * Copyright (C) 2021 UNISOC Technologies Co.,Ltd. All Rights Reserved
 *
 * Automatically generated by code_generator_unirtos.pm.
 */
#include "sci_types.h"
#include "jerry_bindings.h"
#include "js_audio.h"
#include "js_audio_event.h"
#include "ual.h"
#include "ual_audioplayer.h"
//#include "pm_list.h"
#include "permission_check.h"
#define JS_AUDIO_HANDLER_NUMBER_MAX 5

typedef struct
{
    uint32 js_audio_handle;
    uint32 native_audio_handle;
}js_audio_handle_t;
js_audio_handle_t  g_audio_handle[JS_AUDIO_HANDLER_NUMBER_MAX] = {0};//
// TODO:√ê√®√í¬™√Å¬¥¬±√≠¬£¬¨¬∂√†√ä¬µ√Ä√Ω√é√ä√å√¢√ê√®√í¬™¬Ω√¢¬æ√∂
uint32 s_audio_handle_number = 0;
uint32 get_js_audio_handle(uint32 native_audio_handle)
{
    uint32 i=0;
    for(i=0;i<JS_AUDIO_HANDLER_NUMBER_MAX;i++)
    {
        if(native_audio_handle == g_audio_handle[i].native_audio_handle)
        {
            JS_DEBUG_LOG("get_js_audio_handle,native audio handle:%d,index:%d",
            g_audio_handle[i].js_audio_handle,i);
            break;
        }
    }
    return g_audio_handle[i].js_audio_handle;
}
void save_audio_handle(uint32 native_audio_handle,uint32 js_audio_handle)
{
    uint32 i=0;
    for(i=0;i<JS_AUDIO_HANDLER_NUMBER_MAX;i++)
    {
        if(0x0 == g_audio_handle[i].native_audio_handle)
        {
            g_audio_handle[i].js_audio_handle = js_audio_handle;
            g_audio_handle[i].native_audio_handle = native_audio_handle;
            break;
        }
    }
}

void clear_audio_handle(uint32 native_audio_handle)
{
    uint32 i=0;
    for(i=0;i<JS_AUDIO_HANDLER_NUMBER_MAX;i++)
    {
        if(native_audio_handle == g_audio_handle[i].native_audio_handle)
        {
            g_audio_handle[i].js_audio_handle = 0x0;
            g_audio_handle[i].native_audio_handle = 0x0;
            break;
        }
    }
}
boolean audioplayer_process_message(ual_cms_msg_t param)
{

    if (g_audio_handle[0].js_audio_handle == 0) {
        JS_DEBUG_LOG("audioplayer_process_message DROP msg param.id:%d", param.msg_id);
        return false;
    }
    else {
        JS_DEBUG_LOG("audioplayer_process_message,param.id:%d", param.msg_id);
    }
    switch(param.msg_id)
    {
        case UAL_AUDIOPLAYER_MSG_PLAY_IND://play √Ü√∞√Ä¬¥
        {
            uint32 js_audio_handle = 0;
            audio_play_confirm_event_t play_event = {0};
            play_event.type = EVENT_AUDIO_PLAY_CNF;
            JS_DEBUG_LOG("audioplayer_process_message play sucess");
            js_audio_play_confirm_event(g_audio_handle[0].js_audio_handle,&play_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_AUDIO_SUSPEND://audio¬π√í√Ü√∞
        {
            audio_suspend_event_t suspend_event = {0};
            JS_DEBUG_LOG("audioplayer_process_message audio suspend!\n");
            suspend_event.type = EVENT_AUDIO_SUSPEND_IND;
            js_audio_suspend_event(g_audio_handle[0].js_audio_handle,&suspend_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_AUDIO_RESUME://¬ª√ñ¬∏¬¥¬≤¬•¬∑√Ö
        {
            audio_resume_event_t suspend_event = {0};
            JS_DEBUG_LOG("audioplayer_process_message audio resume!\n");
            suspend_event.type = EVENT_AUDIO_RESUME_CNF;
            js_audio_resume_event(g_audio_handle[0].js_audio_handle,&suspend_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_RESUME_IND://¬ª√ñ¬∏¬¥¬≤¬•¬∑√Ö
        {
            audio_resume_confirm_event_t resume_event = { 0 };
            JS_DEBUG_LOG("audioplayer_process_message audio resume conf!\n");
            resume_event.type = EVENT_AUDIO_RESUME_CNF;
            js_audio_resume_event(g_audio_handle[0].js_audio_handle, &resume_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_PLAY_END://¬≤¬•¬∑√Ö√ç√™¬≥√â
        {
            audio_play_end_event_t play_end_event = {0};
            JS_DEBUG_LOG("audioplayer_process_message audio play end!\n");
            play_end_event.type = EVENT_AUDIO_PLAY_END_IND;
            js_audio_play_end_event(g_audio_handle[0].js_audio_handle,&play_end_event);

        }
        break;
        case UAL_AUDIOPLAYER_MSG_PLAY_PROGRESS://¬≤¬•¬∑√Ö¬Ω√∏¬∂√à
        {
            ual_audioplayer_play_progress_info_t play_progress = {0};
            audio_play_progress_event_t play_progress_event = {0};
            JS_DEBUG_LOG("audioplayer_process_message play progress!\n");
            play_progress_event.type = EVENT_AUDIO_PLAY_PROGRESS_IND;
            ual_audioplayer_get_play_progress_info(g_audio_handle[0].native_audio_handle,&play_progress);
            play_progress_event.cur_time = play_progress.cur_time;
            play_progress_event.total_time = play_progress.total_time;
            js_audio_play_progress_event(g_audio_handle[0].js_audio_handle,&play_progress_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_PAUSE_CNF://pause
        case UAL_AUDIOPLAYER_MSG_PAUSE_IND:
        {
            audio_pause_event_t audio_pause_event = {0};
            JS_DEBUG_LOG("audioplayer_process_message pause!\n");
            audio_pause_event.type = EVENT_AUDIO_PAUSE_IND;
            js_audio_pause_event(g_audio_handle[0].js_audio_handle,&audio_pause_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_BUFFERING_IND://¬Ω√∏√à√´buffer√ó¬¥√å¬¨
        {
            audio_begin_buffer_event_t begin_buffer_event = {0};
            begin_buffer_event.type = EVENT_AUDIO_BEGIN_BUFFER_IND;
            JS_DEBUG_LOG("audioplayer_process_message begin buffer!\n");
            js_audio_begin_buffer_event(g_audio_handle[0].js_audio_handle,&begin_buffer_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_BUFFERING_END://buffer¬Ω√°√ä√∏
        {
            audio_end_buffer_event_t end_buffer_event = {0};
            end_buffer_event.type = EVENT_AUDIO_END_BUFFER_IND;
            JS_DEBUG_LOG("audioplayer_process_message end buffer!\n");
            js_audio_end_buffer_event(g_audio_handle[0].js_audio_handle,&end_buffer_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_STOP_CNF:
        case UAL_AUDIOPLAYER_MSG_STOP_IND:
        {
            audio_stop_event_t audio_stop_event = {0};
            audio_stop_event.type = EVENT_AUDIO_STOP_IND;
            JS_DEBUG_LOG("audioplayer_process_message end buffer!\n");
            js_audio_stop_event(g_audio_handle[0].js_audio_handle,&audio_stop_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_ERR:
        {
            audio_error_event_t audio_error_event = {0};
            audio_error_event.type = EVENT_AUDIO_ERROR_IND;
            //Set default err to unknown.
            audio_error_event.err_type = EVENT_AUDIO_UNKNOWN_ERROR;
            if(PNULL != param.p_body)
            {
                ual_audioplayer_err_e audio_err = UAL_AUDIOPLAYER_ERR_MAX;   //bug1996851
                ual_audioplayer_callback_param_t *p_audio_pram = PNULL;
                p_audio_pram = (ual_audioplayer_callback_param_t*)(param.p_body);
                if(PNULL != p_audio_pram)
                {
                    audio_err =(ual_audioplayer_err_e)(p_audio_pram->param_ptr);
                }
                else
                {
                    JS_DEBUG_LOG("UAL_AUDIOPLAYER_MSG_ERR p_audio_pram is PNULL!\n");
                    break;
                }
                if(UAL_AUDIOPLAYER_PARAM_ERROR == audio_err)
                {
                    audio_error_event.err_type = EVENT_AUDIO_PARAM_ERROR;
                }else if(UAL_AUDIOPLAYER_NO_ENOUGH_MMEMORY == audio_err)
                {
                    audio_error_event.err_type = EVENT_AUDIO_NO_ENOUGH_MMEMORY;
                }else if(UAL_AUDIOPLAYER_SET_VOLUME_FAIL == audio_err)
                {
                    audio_error_event.err_type = EVENT_AUDIO_SET_VOLUME_FAIL;
                }else if(UAL_AUDIOPLAYER_GET_PLAY_PROGRESS_FAIL == audio_err)
                {
                    audio_error_event.err_type = EVENT_AUDIO_GET_PLAY_PROGRESS_FAIL;
                }else if(UAL_AUDIOPLAYER_SET_ROUTE_FAIL == audio_err)
                {
                    audio_error_event.err_type = EVENT_AUDIO_SET_ROUTE_FAIL;
                }else if(UAL_AUDIOPLAYER_PLAY_FAIL == audio_err)
                {
                    audio_error_event.err_type = EVENT_AUDIO_PLAY_FAIL;
                }else if(UAL_AUDIOPLAYER_CREATE_FAIL == audio_err)
                {
                    audio_error_event.err_type = EVENT_AUDIO_CREATE_FAIL;
                }else
                {
                     audio_error_event.err_type = EVENT_AUDIO_UNKNOWN_ERROR;
                }
            }
            js_audio_error_event(g_audio_handle[0].js_audio_handle,&audio_error_event);
        }
        break;
        case UAL_AUDIOPLAYER_MSG_NET_NOT_CONNECTED:
        case UAL_AUDIOPLAYER_MSG_NET_TIMEOUT:
        case UAL_AUDIOPLAYER_MSG_NET_CONNECT_ERR:
        {
            audio_error_event_t audio_error_event = {0};
            audio_error_event.type = EVENT_AUDIO_ERROR_IND;
            audio_error_event.err_type = EVENT_AUDIO_NET_ERR;
            js_audio_error_event(g_audio_handle[0].js_audio_handle,&audio_error_event);
        }
        break;
        default:
            break;
    }
    return jerry_create_null();
}
DECLARE_PUBLIC_HANDLER(js_audio_create)
{
    uint32 ual_audioplayer_handle = NULL;
    ual_audioplayer_err_e create_result = UAL_AUDIOPLAYER_ERR_MAX;
    JERRY_CHECK_ARGS(1, object);

    //temp fix bug2133325  such as bug2114788
    if( TRUE == js_art_get_force_exit_flag())//check the current js app for errors
    {
         JS_DEBUG_LOG("ual_audioplayer js app error!\n");
         return jerry_create_null();
    }

    jerry_value_t obj = JERRY_GET_ARG(0, object);
    create_result = ual_audioplayer_create(audioplayer_process_message,&ual_audioplayer_handle);
    if(UAL_AUDIOPLAYER_ERR_NONE == create_result)
    {
        save_audio_handle(ual_audioplayer_handle,jerry_acquire_value(obj));
        return jerry_create_number(ual_audioplayer_handle);
    }
    else
    {
      JS_DEBUG_LOG("ual_audioplayer_err!\n");
      return jerry_create_null();
    }
}

DECLARE_PUBLIC_HANDLER(js_audio_play)
{
    ual_audioplayer_play_param_t play_param = {0};
    uint32 native_audio_handle = jerry_get_number_value(args_p[0]);
    jerry_string_t audio_url = JERRY_GET_ARG(1, string);
    uint32 audio_play_offset = jerry_get_number_value(args_p[2]);
    jerry_size_t audio_url_len = jerry_string_size(&audio_url);
    wchar *p_dst = NULL;
    grant_permission_status_e permission_status = PREMISSION_STATUS_NONE;
    // assert audio permission if allow
    permission_status = PREMISSION_STATUS_GRANTED_ONCE;//perm_check_permission_status(PERM_INTERNET);
    if ((permission_status == PREMISSION_STATUS_DENIED)
        || (permission_status == PREMISSION_STATUS_NONE))
    {
        JS_DEBUG_LOG("perm_check_permission_status = NULL!\n");
        return jerry_create_null();
    }
    JS_DEBUG_LOG("perm_check_permission_status = ALLOW!\n");
    play_param.p_audio_source =
        jerry_buffer_allocate((audio_url_len + 1) * sizeof(wchar));
    if (NULL == play_param.p_audio_source)
    {
        JS_DEBUG_LOG("ual_audioplayer_err!\n");
        return jerry_create_null();
    }
    p_dst = MMIAPICOM_StrToWstr(jerry_string_data(&audio_url),
                                play_param.p_audio_source);

    play_param.audio_source_len = audio_url_len;
    play_param.offset_time = audio_play_offset;

    ual_audioplayer_play(native_audio_handle,&play_param);
    jerry_buffer_release(play_param.p_audio_source);

    return jerry_create_null();
}
DECLARE_PUBLIC_HANDLER(js_audio_pause)
{
    ual_audioplayer_err_e audio_pause_result = 0;
    uint32 native_audio_handle = jerry_get_number_value(args_p[0]);
    audio_pause_result = ual_audioplayer_pause(native_audio_handle);
    if(UAL_AUDIOPLAYER_ERR_NONE == audio_pause_result)
    {
        JS_DEBUG_LOG("js_audio_pause return ok!\n");
    }
    else
    {
        JS_DEBUG_LOG("js_audio_pause return fail!\n");
    }
	return jerry_create_null();
}
DECLARE_PUBLIC_HANDLER(js_audio_stop)
{

    ual_audioplayer_err_e audio_pause_result = 0;
    uint32 native_audio_handle = jerry_get_number_value(args_p[0]);
    audio_pause_result = ual_audioplayer_stop(native_audio_handle);
    if(UAL_AUDIOPLAYER_ERR_NONE == audio_pause_result)
    {
        JS_DEBUG_LOG("js_audio_stop return ok!\n");
    }
    else
    {
        JS_DEBUG_LOG("js_audio_stop return fail!\n");
    }
	return jerry_create_null();
}
DECLARE_PUBLIC_HANDLER(js_audio_resume)
{
    ual_audioplayer_err_e audio_resume_result = 0;
    uint32 native_audio_handle = jerry_get_number_value(args_p[0]);

    audio_resume_result = ual_audioplayer_resume(native_audio_handle);
    if(UAL_AUDIOPLAYER_ERR_NONE == audio_resume_result)
    {
        JS_DEBUG_LOG("js_audio_resume return ok!\n");
    }
    else
    {
        JS_DEBUG_LOG("js_audio_resume return fail!\n");
    }
	return jerry_create_null();

}
DECLARE_PUBLIC_HANDLER(js_audio_get_status)
{
    ual_audioplayer_state_e audio_state = UAL_AUDIOPLAYER_STATE_MAX;
    uint32 native_audio_handle = jerry_get_number_value(args_p[0]);
    audio_state = ual_audioplayer_get_state(native_audio_handle);
    jerry_value_t status_string = 0;;
    switch(audio_state)
    {
        case UAL_AUDIOPLAYER_STATE_IDLE:
        case UAL_AUDIOPLAYER_STATE_READY:
        case UAL_AUDIOPLAYER_STATE_SOURCE_DATA_PREPARE:
        case UAL_AUDIOPLAYER_STATE_PLAY_WAITING:
        case UAL_AUDIOPLAYER_STATE_DESTROYING:
        {
            JS_DEBUG_LOG("js_audio_get_status idle!\n");
            status_string = jerry_create_string(((const jerry_char_t *)"idle"));
        }
        break;
        case UAL_AUDIOPLAYER_STATE_BUFFERING:
        {
            JS_DEBUG_LOG("js_audio_get_status buffer!\n");
            status_string = jerry_create_string(((const jerry_char_t *)"buffering"));
        }
        break;
        case UAL_AUDIOPLAYER_STATE_PLAYING:
        {
            JS_DEBUG_LOG("js_audio_get_status playing!\n");
            status_string = jerry_create_string(((const jerry_char_t *)"playing"));
        }
        break;
        case UAL_AUDIOPLAYER_STATE_PAUSE:
        {
            JS_DEBUG_LOG("js_audio_get_status pause!\n");
            status_string = jerry_create_string(((const jerry_char_t *)"pause"));
        }
        break;
        default:
             JS_DEBUG_LOG("js_audio_get_status state error!\n");
            break;
    }
    return status_string;
}
DECLARE_PUBLIC_HANDLER(js_audio_set_volume)
{
    ual_audioplayer_err_e set_volume_result = 0;
    uint32 native_audio_handle = jerry_get_number_value(args_p[0]);
    uint32 volume = jerry_get_number_value(args_p[1]);
    set_volume_result = ual_audioplayer_set_volume(native_audio_handle,volume);
    if(UAL_AUDIOPLAYER_ERR_NONE == set_volume_result)
    {
        JS_DEBUG_LOG("set set volume sucess!\n");
    }
    else
    {
        JS_DEBUG_LOG("set_volume_result:%d!\n",set_volume_result);
    }
	return jerry_create_null();
}

DECLARE_PUBLIC_HANDLER(js_audio_get_volume)
{
    uint32 native_audio_handle = jerry_get_number_value(args_p[0]);
    uint32 volume = 0;

    volume = ual_audioplayer_get_volume(native_audio_handle);
    return jerry_create_number(volume);
}
DECLARE_PUBLIC_HANDLER(js_audio_get_cur_play_time)
{

}
DECLARE_PUBLIC_HANDLER(js_audio_get_total_time)
{
	return jerry_create_null();
}
DECLARE_PUBLIC_HANDLER(js_audio_get_title)
{
	return jerry_create_null();
}
DECLARE_PUBLIC_HANDLER(js_audio_destroy)
{
    uint32 native_audio_handle = jerry_get_number_value(args_p[0]);
    uint32 js_audio_handle = get_js_audio_handle(native_audio_handle);
    clear_audio_handle(native_audio_handle);
    //√ç¬®¬π√Ωhandle√ï√í¬µ¬Ω¬∂√î√ì¬¶¬µ√Ñaudiohandle
    ual_audioplayer_destroy(native_audio_handle);
    jerry_release_value(js_audio_handle);

	return jerry_create_null();
}
void js_register_audio_functions() {
#ifdef IDL_BINDING_TEST_WITH_STUB
#endif

	REGISTER_HANDLER(js_audio_create);
	REGISTER_HANDLER(js_audio_play);
	REGISTER_HANDLER(js_audio_pause);
	REGISTER_HANDLER(js_audio_stop);
	REGISTER_HANDLER(js_audio_resume);
	REGISTER_HANDLER(js_audio_get_status);
	REGISTER_HANDLER(js_audio_set_volume);
	REGISTER_HANDLER(js_audio_get_volume);
	REGISTER_HANDLER(js_audio_get_cur_play_time);
	REGISTER_HANDLER(js_audio_get_total_time);
	REGISTER_HANDLER(js_audio_get_title);
    REGISTER_HANDLER(js_audio_destroy);

};



// TODO: µœ÷∂‡ µ¿˝ ±£¨≈–∂œ¬ﬂº≠‘Ÿ”≈ªØ

uint8 js_is_audio_exist(void)
{
    uint8 is_exist = FALSE;
    uint32 i=0;

    for(i=0; i<JS_AUDIO_HANDLER_NUMBER_MAX; i++)
    {
        if(0 != g_audio_handle[i].native_audio_handle)
        {
            JS_DEBUG_LOG("js_is_audio_exist");
            is_exist = TRUE;
            break;
        }
    }
    return is_exist;
}

