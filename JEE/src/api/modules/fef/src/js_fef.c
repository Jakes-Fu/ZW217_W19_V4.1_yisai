/*
 * Copyright (C) 2021 UNISOC Technologies Co.,Ltd. All Rights Reserved
 *
 * Automatically generated by code_generator_unirtos.pm.
 */

#include "jerry_bindings.h"
#include "js_fef.h"
#include "sfs.h"


static char* close_export_temple = "\
import %s from \"%s\"; \r\n \
(function() { \r\n \
    return %s; \r\n \
})(); \r\n \
";

extern int js_art_get_app_path(char* buff, int len);

DECLARE_HANDLER(closure_export_object) {
    JERRY_CHECK_ARGS(1, string);
    jerry_string_t content = JERRY_GET_ARG(0, string);
    jerry_size_t size = jerry_string_size(&content);
    char* script_path = jerry_string_data(&content);
    jerry_value_t ret_value;
    char* file_path = NULL;
    char* obj_name = NULL;
    char* dst_script = NULL;
    int i = 0;

    file_path = jerry_buffer_allocate((size + 4) * sizeof(char));
    if (NULL == file_path) {
        jerry_string_destroy(&content);
        return jerry_create_error(JERRY_ERROR_COMMON, "no memory");
    }
    sprintf(file_path, ".%s.js", script_path);

    obj_name = jerry_buffer_allocate((size + 4) * sizeof(char));
    if (NULL == obj_name) {
        jerry_buffer_release(file_path);
        jerry_string_destroy(&content);
        return jerry_create_error(JERRY_ERROR_COMMON, "no memory");
    }
    memset(obj_name, 0, (size + 4) * sizeof(char));
    strncpy(obj_name, script_path, size);
    for (i = 0; i < size; i++) {
        if (obj_name[i] == '/') obj_name[i] = '_';
    }

    dst_script = jerry_buffer_allocate(strlen(close_export_temple)+strlen(file_path)+strlen(obj_name)+8);
    if (NULL == dst_script) {
        jerry_buffer_release(file_path);
        jerry_buffer_release(obj_name);
        jerry_string_destroy(&content);
        return jerry_create_error(JERRY_ERROR_COMMON, "no memory");
    }
    memset(dst_script, 0, strlen(close_export_temple) + strlen(file_path) + strlen(obj_name) + 8);
    sprintf(dst_script, close_export_temple, obj_name, file_path, obj_name);

    ret_value = art_engine_runcode(dst_script);


    jerry_buffer_release(file_path);
    jerry_buffer_release(obj_name);
    jerry_buffer_release(dst_script);
    jerry_string_destroy(&content);

    return jerry_acquire_value(ret_value);
}


void js_register_system_functions() {

    
    REGISTER_HANDLER(closure_export_object);
};
