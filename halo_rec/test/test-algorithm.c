#include "alloc-testing.h"
#include "framework.h"
#include"rsa_sprd.h"
#include "halo_factory_api.h"
//#include "ap_key.h"
extern unsigned char __ap_mn[128];
extern unsigned char __ap_prk[128];
unsigned char mod_N_256[256]={0x98,0x49,0x33,0x45,0x1d,0x64,0xf8,0xd7,0xad,0x8b,0xdb,0x3,0x56,0xd1,0x41,0xdb,0x18,0xb9,0x6b,0x58,0xcb,0x9c,0x8b,0x10,0x4f,0xc9,0xd,0x5e,0xe2,0x14,0xb1,0x6,0xba,0x3c,0x33,0xe6,0xc6,0x76,0xe9,0xe1,0x42,0x69,0x4,0x20,0x9f,0x37,0x35,0xda,0xb5,0x5a,0x16,0x70,0xe8,0x39,0x42,0xd8,0x86,0x8d,0xd1,0x70,0x68,0xdc,0x37,0x9e,0x7f,0x15,0x1b,0xfd,0xdc,0xf9,0xed,0x51,0xec,0x34,0xec,0x85,0x4e,0xb3,0x39,0xcc,0xe3,0x7,0xd1,0x62,0x95,0xd6,0x93,0xfd,0xef,0x62,0x79,0x1b,0xe1,0x21,0x79,0xbd,0xb2,0x9,0xa9,0x57,0xf1,0x6d,0x30,0xc,0x8a,0xf9,0xb0,0x46,0x42,0xca,0x92,0xe3,0x3c,0x17,0xb8,0x99,0x4c,0xd1,0xc,0x59,0xe0,0xb1,0xb2,0xd4,0x55,0xf3,0x7e,0xa,0x6,0x4d,0xf6,0xce,0x71,0x7c,0x28,0x64,0x93,0x29,0xa3,0xa2,0x51,0x1e,0xbb,0x28,0xd0,0xeb,0x56,0x60,0xc1,0x2d,0xbd,0x88,0xb5,0xa4,0xc7,0xae,0x7e,0x42,0xa6,0xab,0x37,0x4b,0x75,0x92,0xf0,0xa5,0x4f,0x19,0x1c,0x44,0x9b,0x5a,0x5d,0x92,0xe5,0xd7,0xed,0xd9,0x58,0xd4,0x13,0x3,0x68,0x8,0x3,0x3e,0x28,0x43,0x38,0x20,0xe,0x42,0xe8,0xe4,0xc6,0xa2,0xba,0xd6,0x18,0x6b,0x3,0x22,0x9b,0xed,0x8c,0x34,0xa0,0x7c,0x22,0x1,0x40,0x30,0xd7,0x78,0xaa,0xc8,0x28,0xe9,0x4e,0x75,0x4e,0xa3,0x5b,0xec,0x5d,0x4e,0x47,0xed,0x68,0xf7,0x12,0x74,0xe0,0x95,0x7b,0x3c,0x21,0xa8,0x94,0x58,0x3c,0x78,0x1d,0x4b,0x67,0xbb,0xe2,0x90,0x39,0x76,0x4f,0x25,0xb,0xba,0x39,0xe1};
unsigned char priExp_256[256]={0x3d,0x89,0x9e,0xf9,0x37,0xe6,0x9c,0x93,0xf3,0x22,0x47,0xcf,0x72,0x9e,0xbe,0xe0,0xfd,0x7d,0xb7,0xfe,0x3a,0xd1,0x38,0x74,0xcf,0xf8,0xeb,0xb9,0x42,0xdc,0x9f,0xa8,0x9b,0x4b,0x46,0xa1,0xe3,0xe3,0x1b,0xa1,0x96,0x47,0x7f,0x8e,0x7b,0x28,0x41,0x4f,0xee,0xe6,0xc7,0x98,0xba,0x8e,0xa1,0xf,0x84,0x57,0xfc,0xa1,0x53,0xe,0x62,0x3f,0x5f,0x15,0x35,0xa9,0x81,0x49,0x51,0x78,0x40,0x5e,0x26,0x91,0xbb,0xfa,0xba,0xc9,0xab,0x98,0x76,0x29,0x43,0x69,0x61,0x86,0x44,0xdc,0xe3,0x19,0xbc,0x0,0xde,0x4,0x24,0xd4,0xb8,0xa4,0xbb,0xff,0xa6,0x61,0xfb,0x2a,0xe8,0xeb,0x8b,0x83,0xf6,0x95,0x72,0xac,0x17,0x41,0x83,0x84,0x1a,0x5c,0x9b,0x6a,0xd3,0x5b,0xf0,0x9b,0xa3,0x7b,0x5f,0xc,0x61,0x4e,0xe,0x4,0x58,0x7d,0x9e,0x8f,0x4a,0x63,0x39,0xf,0xc2,0x29,0xee,0x91,0x59,0x28,0xf7,0xd6,0xfd,0xcc,0xba,0xba,0xcc,0x58,0x6e,0xe,0x21,0xee,0x81,0x5d,0xaf,0x6f,0xd5,0x94,0xa4,0xbd,0xd0,0xee,0xed,0x15,0x36,0x2d,0xb,0x25,0xec,0xfa,0x81,0x4,0x2c,0x4d,0xa9,0xe5,0xa8,0x8e,0x9b,0x19,0x1b,0x4f,0x4f,0x8b,0xc6,0xfd,0x27,0xda,0x48,0xb5,0x40,0xf9,0x24,0x66,0x2a,0xb9,0x58,0x19,0x78,0x8b,0x7a,0xdf,0x21,0x6a,0xd2,0xae,0xbd,0x7,0x7c,0xf7,0x4e,0xe4,0xc8,0xc9,0xaa,0x28,0xfd,0x33,0x44,0x77,0xfa,0xeb,0x3c,0x80,0x0,0x95,0xf5,0xb4,0x2e,0x71,0x9,0x1e,0x45,0x10,0x4a,0xf4,0xe2,0x3b,0xda,0x8a,0xc8,0xb2,0x77,0x4a,0xc4,0x59,0x63,0xfd};
unsigned char text[64] = {0xFE,0x22,0x33,0x44,0x55,0x66,0x77,0x88,\
							0xFE,0x22,0x33,0x44,0x55,0x66,0x77,0x88,\
							0xFE,0x22,0x33,0x44,0x55,0x66,0x77,0x88,\
							0xFE,0x22,0x33,0x44,0x55,0x66,0x77,0x88,\
							0xFE,0x22,0x33,0x44,0x55,0x66,0x77,0x88,\
							0xFE,0x22,0x33,0x44,0x55,0x66,0x77,0x88,\
							0xFE,0x22,0x33,0x44,0x55,0x66,0x77,0x88,\
							0xFE,0x22,0x33,0x44,0x55,0x66,0x77,0x88};
unsigned char test_pubExp[4] = {0x00,0x01,0x00,0x01}; //{0x00,0x00,0x00,0x03};  //
unsigned char test_sys_key[32] = {0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88};
unsigned char digest[4] = {0x31,0x32,0x33,0x34};
unsigned char test_mod_N[0x8] = {0x9f,0xa1,0x66,0x3b};   //{0xe1,0xe8,0x54,0xe1};  //{0xad,0x21,0xf1,0x91};//
unsigned char prvExp[0x8]= {0x2d,0x1c,0xe1,0x91};   //{0x96,0x99,0x6e,0x63}; //{0x73,0x6a,0xdd,0x23};
unsigned char uid[8] = {0x0,0x01,0xb0,0x9,0xb,0x1c,0x0e,0x07};//"45128986";
unsigned char test_flist[64] = {0};


extern int SHA1_ALGO(const unsigned int *message_array,unsigned int length,unsigned char *digest_result);
static unsigned char test_rsa_signverify(void)
{ 
	boolean ret = 0;
	int i = 0;
	unsigned char sign_result[8] = {0};
	unsigned char* sign_result256 = NULL;

	sign_result256 = HALO_Malloc(256);
	if(!sign_result256)
	{
		return false;
	}
  
 /*sprd rsa sign 64 bits license with 8bytes(64bits) length uid test*/
  ret = sprd_rsa_sign(prvExp,test_mod_N,uid,64,test_sys_key,sign_result);
  PRTF_BLOCK("sprd_rsa_sign :",sign_result,4);
  HALO_JUDGE_STR(TEST sprd_rsa_sign 64bits,ret == 1,ret);
  
  ret = sprd_rsa_verify(test_pubExp,test_mod_N,uid,64,test_sys_key,sign_result);
  HALO_JUDGE_STR(TEST sprd_rsa_verify 64bits,ret == 1,ret);
 



//extern boolean sprd_rsa_sign128_256(unsigned char *prvExp,unsigned char *mod_N,unsigned char *uid,int uid_bitlen, int flen, unsigned char *sys_key,unsigned char *sign_result);
//extern boolean sprd_rsa_verify128_256(unsigned char *pubExp,unsigned char *mod_N,unsigned char *uid,int uid_bitlen,int flen, unsigned char *sys_key,unsigned char *en_sign_result);


/*sprd rsa sign 1024 bits license test*/
 PRTF("test 128byte encode and decode \n");

/*sprd rsa sign 1024 bits license with 64bytes(512bits) length text*/

  ret = sprd_rsa_sign128_256(__ap_prk,__ap_mn,text,1024,64,test_sys_key,sign_result256);

  PRTF("after sprd_rsa_sign128_256 sign 128bytes:\n");
  PRTF_BLOCK("after sprd_rsa_sign128_256 sign 128bytes :",sign_result256,128);
  HALO_JUDGE_STR(TEST sprd_rsa_sign128_256 1024bits,ret == 1,ret);

 /*sprd rsa verify 1024 bits license*/
  ret = sprd_rsa_verify128_256(test_pubExp,__ap_mn,text,1024,64,test_sys_key,sign_result256, test_flist);
  PRTF("sprd_rsa_verify128_256 128bytes finished:\n");
  HALO_JUDGE_STR(TEST sprd_rsa_verify128_256 1024bits,ret == 1,ret);
 



 /*sprd rsa sign 2048 bits license test*/
PRTF("test 256byte encode and decode \n");

/*sprd rsa sign 2048 bits license with 64bytes(512bits) length text*/
ret = sprd_rsa_sign128_256(priExp_256,mod_N_256,text,2048,64,test_sys_key,sign_result256);
  PRTF("after sprd_rsa_sign128_256 sign 256bytes:\n");
  PRTF_BLOCK("after sprd_rsa_sign128_256 sign 256bytes :",sign_result256,256);
  HALO_JUDGE_STR(TEST sprd_rsa_sign128_256 2048bits,ret == 1,ret);
 
  
 /*sprd rsa verify 2048 bits license*/
  ret = sprd_rsa_verify128_256(test_pubExp,mod_N_256,text,2048,64,test_sys_key,sign_result256, test_flist);
  PRTF("sprd_rsa_verify128_256 256bytes finished:\n");
  HALO_JUDGE_STR(TEST sprd_rsa_verify128_256 256bytes ,ret == 1,ret);

	HALO_Free(sign_result256);
	sign_result256 = NULL;
 return 0;

  
}

static unsigned char test_featurelist(void)
{
  uint8 ret = 0;
  uint8 test_feature[84] = {0};
  uint8 test_digest[20] = {0};
  HALO_Memcpy(test_feature, text, 64);
  ret = SHA1_ALGO((unsigned int *)test_feature,64>>2,test_digest);
  HALO_Memcpy(test_feature+64, test_digest, 20);
  PRTF_BLOCK("test_featurelist generate test feature list :",test_feature,84);
  ret = HALO_set_featurelist(test_feature);
  PRTF_BLOCK("test_featurelist HALO_set_featurelist encode:",test_feature,84);
  ret = HALO_get_featurelist(test_feature);
  PRTF("HALO_get_featurelist finished ret [0x%02X]", ret);
  PRTF_BLOCK("test_featurelist HALO_get_featurelist :",test_feature,84);
}


static Unit_Test_T tests[] = {
	TEST(test_rsa_signverify),
	TEST(test_featurelist),
	{NULL,NULL}
};



int test_algo(void)
{
	run_tests(tests);

	return 0;
}
